library(dplyr)
library(rgdal)
library(raster)
library(magrittr)
library(ggplot2)

GRACE <- raster("Z:/2.active_projects/Xander/! GIS_files/GRACE/GRACE_coredata.tif")


## Part 1: Create indicator: prevalence of sustainability pillars
# Import global datasets of the three sustainability pillars
## Society - proxy of population
Population <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/POP_2015_0d05.tif")
Population[Population == 0] <- NA
## Economy - proxy of GDP
GDP <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/GDP_0d05.tif")
GDP[GDP == 0] <- NA
## Environment - proxy of amphibian species richness
AmphSpRch <- raster("Z:/2.active_projects/Xander/! GIS_files/Biodiversity/Raster/Amph_SpeciesRichness/Richness_10km_AMPHIBIANS0d05.tif")
# resample species richness to achieve consistent resolution and origin
AmphSpRch <- resample(AmphSpRch, GRACE, method='ngb')
AmphSpRch[AmphSpRch == 0] <- NA

# Initialize rasters to classify the percentile distribution
PopQuantile <- raster(Population)
GDPQuantile <- raster(GDP)
BioQuantile <- raster(AmphSpRch)

# Create a function to create a global raster which takes a global distribution raster and reclassifies it by percentile
PercentileAssignment <- function(QuantileRaster, RawRaster){
  QuantileRaster[] <- 0
  QuantileRaster[RawRaster > quantile(RawRaster, 0.99, na.rm = TRUE)] <- 1
  j = 1
  k = 0.99
  for(i in 1:98){
    j = j - 0.01
    k = k - 0.01
    QuantileRaster[RawRaster <= quantile(RawRaster, j, na.rm = TRUE) & RawRaster > quantile(RawRaster, k, na.rm = TRUE)] <- j
  }
  QuantileRaster[RawRaster < quantile(RawRaster, 0.01, na.rm = TRUE)] <- 0
  return(QuantileRaster)
}

# Reclassify population raster based on quantile using above function
PopQuantile <- PercentileAssignment(PopQuantile, Population)
GDPQuantile <- PercentileAssignment(GDPQuantile, GDP)
AmphQuantile <- PercentileAssignment(BioQuantile, AmphSpRch)

writeRaster(PopQuantile, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/PopQuantile.tif", 
            format="GTiff", overwrite=TRUE)

writeRaster(GDPQuantile, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/GDPQuantile.tif", 
            format="GTiff", overwrite=TRUE)

writeRaster(AmphQuantile, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/AmphQuantile.tif", 
            format="GTiff", overwrite=TRUE)


# Average the global percentile distributions 
Prevalence <- raster(GRACE)
Prevalence[] <- 0
Prevalence[] <- (PopQuantile[] + GDPQuantile[] + AmphQuantile[])/3
Prevalence.ind <- Prevalence
writeRaster(Prevalence.ind, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/Prevalence.ind.tif", 
            format="GTiff", overwrite=TRUE)


## Part 2 Create indicator: institutional resilience capacity 
# Import global datasets of the three resilience capacity indeces
## Perceived Corruption Index
CPI_scores <- read.csv("Z:/2.active_projects/Xander/! GIS_files/Corruption/CPI_2018.csv")
Country.shp <- readOGR(dsn = "Z:/2.active_projects/Xander/! GIS_files/NaturalEarth",
                       layer = "ne_10m_admin_0_countries")
keepcols <- c("SOVEREIGNT", "ISO_A3", "ADM0_A3", "NAME", "NAME_LONG")
Country.shp <- Country.shp[,keepcols, drop = FALSE]
Country.shp <- merge(Country.shp, CPI_scores, by.x = "ISO_A3", by.y = "ISO3")
Country.shp <- Country.shp[order(-Country.shp$CPI.Score.2018),]

# Write to new shapefile so that vector shapefile can be rasterized in QGIS
writeOGR(Country.shp, dsn="E:/! GIS_files/Corruption/CPI_countries.shp", 
         layer = "CPI_countries", driver="ESRI Shapefile", overwrite_layer=TRUE)
# Rasterize exported shapefile to 0.05d resolution in QGIS (optimal performance to R) for corruption perception index
# and re-import here
Corruption <- raster("Z:/2.active_projects/Xander/! GIS_files/Corruption/CPI_0d05.tif")

## Gross national income per capita
GNIpc <- read.csv("Z:/2.active_projects/Xander/! GIS_files/Wealth/GNI_usd.csv")
Country.shp$ISO_A3 <- ifelse(Country.shp$ISO_A3 == "-99", as.character(Country.shp$ADM0_A3), as.character(Country.shp$ISO_A3))
Wealth.shp <- merge(Country.shp, GNIpc, by.x = "ISO_A3", by.y = "ID3")
Wealth.shp <- Wealth.shp[order(-Wealth.shp$GNI_usd),]
# Write to new shapefile so that vector shapefile can be rasterized in QGIS
writeOGR(Wealth.shp, dsn="Z:/2.active_projects/Xander/! GIS_files/Wealth/GNIpc.shp", 
         layer = "GNIpc", driver="ESRI Shapefile", overwrite_layer=TRUE)
# and re-import here
GNIpc_ras <- raster("Z:/2.active_projects/Xander/! GIS_files/Wealth/GNIpc_0d05.tif")

## Protected lands
ProtectedAreas <- raster("Z:/2.active_projects/Xander/! GIS_files/WorldProtectedAreas/WDPA_binary_0d05.tif")

# Normalize corruption scores (high score  = low corruption; max == 1)
Corruption.ind <- Corruption/100

# Normalize national wealth by World Bank threshold for high income nations 
## set wealth.ind to corr.ind in instances where national wealth is not reported
Wealth.ind <- GNIpc_ras/12055
Wealth.ind[Wealth.ind > 1] <- 1
## set wealth.ind to corr.ind in instances where national wealth is not reported
Wealth.ind[is.na(Wealth.ind)] <- Corruption.ind[is.na(Wealth.ind)]

# Calculate average protected area's at 10x refinement, and resample to same resolution as before
ProtectedAres_average <- raster::aggregate(x = ProtectedAreas, fact = 10, fun = "mean", expand = TRUE)
ProtectedAres_average <- resample(ProtectedAres_average, GRACE, method='ngb')
Eco.ind <- ProtectedAres_average

writeRaster(Eco.ind, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/ProtectedAreas_0d5Average.tif", 
            format="GTiff", overwrite=TRUE)

# Calculate combined institutional resilience of sustainability pillars
Resilience.ind <- (1/3)*(Corruption.ind + Wealth.ind + Eco.ind)

writeRaster(Resilience.ind, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/Resilience.ind.tif", 
            format="GTiff", overwrite=TRUE)

## Part 2.3: Combine prevalence and resilience indicators to create vulnerability filter
# 
# initialize filter raster
Vulnerability.filter <- raster(GRACE)

Vulnerability.filter <- 0.5 * (Prevalence.ind + (1-Resilience.ind)) # inverse of resilience indicator as vulnerability comes from low resilience

writeRaster(Vulnerability.filter, 
            filename="Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/Vulnerability.filter.tif", 
            format="GTiff", overwrite=TRUE)
