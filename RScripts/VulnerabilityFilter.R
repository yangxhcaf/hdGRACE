library(dplyr)
library(rgdal)
library(raster)
library(magrittr)
library(ggplot2)

## Part 1: Create indicator: prevalence of sustainability pillars
# Import global datasets of the three sustainability pillars
## Society - proxy of population
Population <- raster("E:/! Xander/! Research/GIS_files/R_gis_exports/POP_2015_0d05.tif")
## Economy - proxy of GDP
GDP <- raster("E:/! Xander/! Research/GIS_files/R_gis_exports/GDP_0d05.tif")
GDP[GDP == 0] <- NA
## Environment - proxy of amphibian species richness
AmphSpRch <- raster("E:/! Xander/! Research/GIS_files/Biodiversity/Raster/Amph_SpeciesRichness/Richness_10km_AMPHIBIANS0d05.tif")
# resample species richness to achieve consistent resolution and origin
s <- raster(nrow=3600, ncol=7200)
AmphSpRch <- resample(AmphSpRch, s, method='ngb')
AmphSpRch[AmphSpRch == 0] <- NA

# Initialize rasters to classify the percentile distribution
PopQuantile <- raster(Population)
GDPQuantile <- raster(GDP)
BioQuantile <- raster(AmphSpRch)

# Create a function to create a global raster which takes a global distribution raster and reclassifies it by percentile
PercentileAssignment <- function(QuantileRaster, RawRaster){
  QuantileRaster[] <- 0
  QuantileRaster[RawRaster > quantile(RawRaster, 0.95, na.rm = TRUE)] <- 1
  j = 1
  k = 0.95
  for(i in 1:18){
    j = j - 0.05
    k = k - 0.05
    QuantileRaster[RawRaster <= quantile(RawRaster, j, na.rm = TRUE) & RawRaster > quantile(RawRaster, k, na.rm = TRUE)] <- j
  }
  QuantileRaster[RawRaster < quantile(RawRaster, 0.05, na.rm = TRUE)] <- 0
  return(QuantileRaster)
}

# Reclassify population raster based on quantile using above function
PopQuantile <- PercentileAssignment(PopQuantile, Population)
GDPQuantile <- PercentileAssignment(GDPQuantile, GDP)
BioQuantile <- PercentileAssignment(BioQuantile, AmphSpRch)

# Average the global percentile distributions 
Prevalence <- raster(EmergingTrend)
Prevalence[] <- 0
Prevalence[] <- (PopQuantile[] + GDPQuantile[] + BioQuantile[])/3
Prevalence.ind <- Prevalence
writeRaster(Prevalence, 
            filename="E:/! Xander/! Research/GIS_files/R_gis_exports/ThreePillarPrevalence.tif", 
            format="GTiff", overwrite=TRUE)


## Part 2 Create indicator: institutional resilience capacity 
# Import global datasets of the three resilience capacity indeces
## Perceived Corruption Index
CPI_scores <- read.csv("E:/! Xander/! Research/GIS_files/Corruption/CPI_2018.csv")
Country.shp <- readOGR(dsn = "E:/! Xander/! Research/GIS_files/NaturalEarth",
                       layer = "ne_10m_admin_0_countries")
Country.shp <- Country.shp[,-(1:3)]
Country.shp <- Country.shp[,-(3:6)]
Country.shp <- Country.shp[,-(4)]
Country.shp <- Country.shp[,-(4:9)]
Country.shp <- Country.shp[,-(6:ncol(Country.shp))]
Country.shp <- Country.shp[,-(6:30)]
Country.shp <- Country.shp[,-(21:ncol(Country.shp))]
Country.shp <- Country.shp[,-(14:16)]
Country.shp <- merge(Country.shp, CPI_scores, by.x = "ISO_A3", by.y = "ISO3")
Country.shp <- Country.shp[order(-Country.shp$CPI.Score.2018),]
# Write to new shapefile so that vector shapefile can be rasterized in QGIS
writeOGR(Country.shp, dsn="E:/! Xander/! Research/GIS_files/Corruption/CPI_countries.shp", 
         layer = "CPI_countries", driver="ESRI Shapefile", overwrite_layer=TRUE)
# Rasterize exported shapefile to 0.05d resolution in QGIS (optimal performance to R) for corruption perception index
# and re-import here
Corruption <- raster("E:/! Xander/! Research/GIS_files/Corruption/CPI_0d05.tif")

## Total national wealth per capita
Wealth <- read.csv("E:/! Xander/! Research/GIS_files/Wealth/Wealth-AccountsData.csv")
Wealth %<>% filter(Indicator.Code == "NW.TOW.PC")
Wealth <- Wealth[-(1:17),]
Wealth <- Wealth[,-(3:7)]
Wealth <- Wealth[,-(5)]
Wealth.shp <- merge(Country.shp, Wealth, by.x = "ADM0_A3_US", by.y = "Country.Code")
Wealth.shp <- Wealth.shp[order(-Wealth.shp$X2014),]
# Write to new shapefile so that vector shapefile can be rasterized in QGIS
writeOGR(Wealth.shp, dsn="E:/! Xander/! Research/GIS_files/Wealth/Wealth.shp", 
         layer = "Wealth", driver="ESRI Shapefile", overwrite_layer=TRUE)
# and re-import here
Wealth.nation <- raster("E:/! Xander/! Research/GIS_files/Wealth/NationalWealth_0d05.tif")
## Protected lands
ProtectedAreas <- raster("E:/! Xander/! Research/GIS_files/WorldProtectedAreas/WDPA_binary_0d05.tif")

# Normalize corruption scores (high score  = low corruption; max == 1)
Corruption.ind <- Corruption/100
# Normalize national wealth by average wealth of high income non-oecd nations ($241,224.00)
## set wealth.ind to corr.ind in instances where national wealth is not reported
Wealth.ind <- Wealth.nation/241224
Wealth.ind[Wealth.ind > 1] <- 1
## set wealth.ind to corr.ind in instances where national wealth is not reported
Wealth.ind[is.na(Wealth.ind)] <- Corruption.ind[is.na(Wealth.ind)]
# Calculate average protected area's at 10x refinement, and resample to same resolution as before
ProtectedAres_average <- raster::aggregate(x = ProtectedAreas, fact = 10, fun = "mean", expand = TRUE)
ProtectedAres_average <- resample(ProtectedAres_average, s, method='ngb')
Eco.ind <- ProtectedAres_average
# Calculate combined institutional resilience of sustainability pillars
Resilience.ind <- ((1/3)*Corruption.ind) + ((1/3)*Wealth.ind) + ((1/3)*Eco.ind)

writeRaster(Resilience.ind, 
            filename="E:/! Xander/! Research/GIS_files/R_gis_exports/Resilience.ind.tif", 
            format="GTiff", overwrite=TRUE)


## Part 2.3: Combine prevalence and resilience indicators to create vulnerability filter
# 
# initialize filter raster
Vulnerability.filter <- raster(EmergingTrend)

Prev.high = 1.0
Prev.low = 0.9
a = 55

# run imbedded for loops to classify based on 10x10 combination
for(k in 1:10){
  Resil.high = 1.0
  Resil.low = 0.9
  for(j in 1:10)
  {
    Vulnerability.filter[Prevalence.ind <= Prev.high & Prevalence.ind > Prev.low &
                           Resilience.ind <= Resil.high &  Resilience.ind > Resil.low] <- a + ((j-1)*5)
    j = j + 1
    Resil.high = Resil.high - 0.1
    Resil.low = Resil.low - 0.1
  }
  a = a - 5
  Prev.high = Prev.high - 0.1
  Prev.low = Prev.low - 0.1
  k = k + 1
}
Vulnerability.filter <- Vulnerability.filter/100
writeRaster(Vulnerability.filter, 
            filename="E:/! Xander/! Research/GIS_files/R_gis_exports/Vulnerability.filter.tif", 
            format="GTiff", overwrite=TRUE)

