library(sp)
library(raster)
library(rgdal)
library(dplyr)
library(ggspatial)
library(ggplot2)
library(e1071)
library(scales)
library(magrittr)
library(reshape2)
library(RColorBrewer)
library(Hmisc)
library(quantreg)
library(spatstat)
library(reldist)

# load risk distributions
FLOOD_risk <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/GRACEmod_FLOODS.tif")
FLOOD_risk[FLOOD_risk[] > 5] <- 5
STRESS_risk <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/GRACEmod_STRESS.tif")
STRESS_risk[STRESS_risk[] > 5] <- 5

# load raster cell area in km2 at 0d05 resolution
CellArea <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/WGS84_cellArea_0d05res.tif")

VulnerabiliyFilter <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/VulnerabilityFilter.tif")
# reclassify vulnerability filter
VulnerabilityCLASS <- raster(CellArea)
VulnerabilityCLASS[] <- ifelse(VulnerabiliyFilter[] < 0.3, 1, 
                               ifelse(VulnerabiliyFilter[] < 0.5, 2, 
                                      ifelse(VulnerabiliyFilter[] < 0.7, 3,
                                             ifelse(VulnerabiliyFilter[] < 1, 4, NA))))

# Reclassify WSV flood into classes
Flood_risk_class <- raster(CellArea)
Flood_risk_class[] <- ifelse(FLOOD_risk[] < 1, 1,
                            ifelse(FLOOD_risk[] < 2, 2,
                                   ifelse(FLOOD_risk[] < 3, 3,
                                          ifelse(FLOOD_risk[] < 4, 4,
                                                 ifelse(FLOOD_risk[] < 6, 5, NA)))))

# Reclassify WSV stress into classes
Stress_risk_class <- raster(CellArea)
Stress_risk_class[] <- ifelse(STRESS_risk[] < 1, 1,
                            ifelse(STRESS_risk[] < 2, 2,
                                   ifelse(STRESS_risk[] < 3, 3,
                                          ifelse(STRESS_risk[] < 4, 4,
                                                 ifelse(STRESS_risk[] < 6, 5, NA)))))

# remove antarctica from analysis
Antarctica <- raster("Z:/2.active_projects/Xander/! GIS_files/NaturalEarth/Antarctica.tif")
VulnerabilityCLASS[Antarctica[] == 1] <- NA
Flood_risk_class[Antarctica[] == 1] <- NA
Stress_risk_class[Antarctica[] == 1] <- NA

# Derive raster for all unique combinations of vulnerability class and WSV flood class
Flood.matrix <- raster(CellArea)
Flood.matrix[] <- NA
Flood.matrix[VulnerabilityCLASS[] == 1 & Flood_risk_class[] == 5] <- 1
Flood.matrix[VulnerabilityCLASS[] == 1 & Flood_risk_class[] == 4] <- 2
Flood.matrix[VulnerabilityCLASS[] == 1 & Flood_risk_class[] == 3] <- 3
Flood.matrix[VulnerabilityCLASS[] == 1 & Flood_risk_class[] == 2] <- 4
Flood.matrix[VulnerabilityCLASS[] == 1 & Flood_risk_class[] == 1] <- 5

Flood.matrix[VulnerabilityCLASS[] == 2 & Flood_risk_class[] == 5] <- 6
Flood.matrix[VulnerabilityCLASS[] == 2 & Flood_risk_class[] == 4] <- 7
Flood.matrix[VulnerabilityCLASS[] == 2 & Flood_risk_class[] == 3] <- 8
Flood.matrix[VulnerabilityCLASS[] == 2 & Flood_risk_class[] == 2] <- 9
Flood.matrix[VulnerabilityCLASS[] == 2 & Flood_risk_class[] == 1] <- 10

Flood.matrix[VulnerabilityCLASS[] == 3 & Flood_risk_class[] == 5] <- 11
Flood.matrix[VulnerabilityCLASS[] == 3 & Flood_risk_class[] == 4] <- 12
Flood.matrix[VulnerabilityCLASS[] == 3 & Flood_risk_class[] == 3] <- 13
Flood.matrix[VulnerabilityCLASS[] == 3 & Flood_risk_class[] == 2] <- 14
Flood.matrix[VulnerabilityCLASS[] == 3 & Flood_risk_class[] == 1] <- 15

Flood.matrix[VulnerabilityCLASS[] == 4 & Flood_risk_class[] == 5] <- 16
Flood.matrix[VulnerabilityCLASS[] == 4 & Flood_risk_class[] == 4] <- 17
Flood.matrix[VulnerabilityCLASS[] == 4 & Flood_risk_class[] == 3] <- 18
Flood.matrix[VulnerabilityCLASS[] == 4 & Flood_risk_class[] == 2] <- 19
Flood.matrix[VulnerabilityCLASS[] == 4 & Flood_risk_class[] == 1] <- 20

# merge flood matrix raster with cell area weight raster
Population <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/POP_2015_0d05.tif")

Flood.matrix_pop <- zonal(Population, Flood.matrix, "sum")
Flood.matrix_pop %<>% as.data.frame()
IDs <- c(seq(1, 20,by = 1)) %>% as.data.frame()
colnames(IDs) <- "ID"
Flood.matrix_pop <- merge.data.frame(IDs, Flood.matrix_pop, by.x = "ID", by.y = "zone", all = TRUE)
Flood.matrix_pop$sum <- ifelse(is.na(Flood.matrix_pop$sum), 0, Flood.matrix_pop$sum)
colnames(Flood.matrix_pop) <- c("ID", "POP")

Flood.matrix_pop$Vulnerability <- c(1,1,1,1,1,
                                     2,2,2,2,2,
                                     3,3,3,3,3,
                                     4,4,4,4,4)

Flood.matrix_pop$FloodRisk <- c(5,4,3,2,1,
                                 5,4,3,2,1,
                                 5,4,3,2,1,
                                 5,4,3,2,1)
Flood.matrix_pop$FloodRisk %<>% as.factor()

g1 <- ggplot(Flood.matrix_pop, aes(Vulnerability, weight = POP)) +
  geom_bar(position = position_fill(reverse = TRUE), aes(fill = FloodRisk),color= "black")+
  scale_fill_manual("legend", values = c("5" = "dodgerblue4", "4" = "dodgerblue3", "3" = "dodgerblue",
                                         "2" = "lightblue1", "1" = "azure3"))+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA))
g1

ggsave("C:/Users/Tom/Desktop/!FloodRisk_cat_pop_fill.png", g1, dpi = 500, width = 5.5, height = 5, bg = "transparent")

# Flood.matrix_area %>% filter(Vulnerability == 4) %>% pull(Area) %>% sum() # for checking correct stats

# now repeat for WSV stress class
Stress.matrix <- raster(CellArea)
Stress.matrix[] <- NA
Stress.matrix[VulnerabilityCLASS[] == 1 & Stress_risk_class[] == 5] <- 1
Stress.matrix[VulnerabilityCLASS[] == 1 & Stress_risk_class[] == 4] <- 2
Stress.matrix[VulnerabilityCLASS[] == 1 & Stress_risk_class[] == 3] <- 3
Stress.matrix[VulnerabilityCLASS[] == 1 & Stress_risk_class[] == 2] <- 4
Stress.matrix[VulnerabilityCLASS[] == 1 & Stress_risk_class[] == 1] <- 5

Stress.matrix[VulnerabilityCLASS[] == 2 & Stress_risk_class[] == 5] <- 6
Stress.matrix[VulnerabilityCLASS[] == 2 & Stress_risk_class[] == 4] <- 7
Stress.matrix[VulnerabilityCLASS[] == 2 & Stress_risk_class[] == 3] <- 8
Stress.matrix[VulnerabilityCLASS[] == 2 & Stress_risk_class[] == 2] <- 9
Stress.matrix[VulnerabilityCLASS[] == 2 & Stress_risk_class[] == 1] <- 10

Stress.matrix[VulnerabilityCLASS[] == 3 & Stress_risk_class[] == 5] <- 11
Stress.matrix[VulnerabilityCLASS[] == 3 & Stress_risk_class[] == 4] <- 12
Stress.matrix[VulnerabilityCLASS[] == 3 & Stress_risk_class[] == 3] <- 13
Stress.matrix[VulnerabilityCLASS[] == 3 & Stress_risk_class[] == 2] <- 14
Stress.matrix[VulnerabilityCLASS[] == 3 & Stress_risk_class[] == 1] <- 15

Stress.matrix[VulnerabilityCLASS[] == 4 & Stress_risk_class[] == 5] <- 16
Stress.matrix[VulnerabilityCLASS[] == 4 & Stress_risk_class[] == 4] <- 17
Stress.matrix[VulnerabilityCLASS[] == 4 & Stress_risk_class[] == 3] <- 18
Stress.matrix[VulnerabilityCLASS[] == 4 & Stress_risk_class[] == 2] <- 19
Stress.matrix[VulnerabilityCLASS[] == 4 & Stress_risk_class[] == 1] <- 20

# merge Stress matrix raster with cell area weight raster
Population <- raster("Z:/2.active_projects/Xander/! GIS_files/R_gis_exports/POP_2015_0d05.tif")

Stress.matrix_POST <- zonal(Population, Stress.matrix, "sum")
Stress.matrix_POST %<>% as.data.frame()
IDs <- c(seq(1, 20,by = 1)) %>% as.data.frame()
colnames(IDs) <- "ID"
Stress.matrix_POST <- merge.data.frame(IDs, Stress.matrix_POST, by.x = "ID", by.y = "zone", all = TRUE)
Stress.matrix_POST$sum <- ifelse(is.na(Stress.matrix_POST$sum), 0, Stress.matrix_POST$sum)
colnames(Stress.matrix_POST) <- c("ID", "POP")

Stress.matrix_POST$Vulnerability <- c(1,1,1,1,1,
                                     2,2,2,2,2,
                                     3,3,3,3,3,
                                     4,4,4,4,4)

Stress.matrix_POST$StressRisk <- c(5,4,3,2,1,
                                 5,4,3,2,1,
                                 5,4,3,2,1,
                                 5,4,3,2,1)
Stress.matrix_POST$StressRisk %<>% as.factor()

g2 <- ggplot(Stress.matrix_POST, aes(Vulnerability, weight = POP)) +
  geom_bar(position = position_stack(reverse = TRUE), aes(fill = StressRisk),color= "black")+
  scale_fill_manual("legend", values = c("5" = "red4", "4" = "red", "3" = "orange",
                                         "2" = "yellow", "1" = "lightgoldenrod1"))+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA))
g2

ggsave("C:/Users/Tom/Desktop/!StressRisk_cat_pop_fill.png", g2, dpi = 500, width = 5.5, height = 5, bg = "transparent")

# Flood.matrix_area %>% filter(Vulnerability == 4) %>% pull(Area) %>% sum() # for checking correct stats
colnames(Stress.matrix_POST) <- c("ID", "POP_post", "Vulnerability", "StressRisk")
colnames(Stress.matrix_PRE)  <- c("ID", "POP_pre", "Vulnerability", "StressRisk")
MergedStressMatrix <- merge.data.frame(Stress.matrix_POST, Stress.matrix_PRE, by.x = "ID", by.y = "ID", all = TRUE)
MergedStressMatrix$PopChange <- MergedStressMatrix$POP_post - MergedStressMatrix$POP_pre
MergedStressMatrix$PopChangeRescale <- ifelse(MergedStressMatrix$PopChange < -100e6, -100e6,
                                              ifelse(MergedStressMatrix$PopChange > 100e6, 100e6, 
                                                     MergedStressMatrix$PopChange))

MergedStressMatrix$PercentChange <- MergedStressMatrix$PopChange/MergedStressMatrix$POP_pre


p <- ggplot(MergedStressMatrix, aes(Vulnerability.x, StressRisk.x)) + 
  geom_tile(aes(fill = PercentChange), colour = "white") + 
  scale_fill_gradientn(colours = c("red3", "red3","lemonchiffon2",
                                   "royalblue1", "royalblue4"))
                       values = rescale(c(350, 380.5, 403, 415.5, 431))

